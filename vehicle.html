<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Kirana Vehicle Planner — Grouped Kirana + Depot</title>
<style>
  :root{
    --purple:#4b0082;
    --purple-2:#6a0dad;
    --yellow:#ffd84d;
    --light:#fffbe6;
    --card:#fffdf3;
  }
  body{ font-family: "Segoe UI", Roboto, Arial, sans-serif; background: linear-gradient(180deg,#fffdf8 0%, #fff7e6 100%); color:var(--purple); margin:0; padding:18px; }
  .wrap{ max-width:1200px; margin:0 auto; }
  h1{ text-align:center; color:var(--purple); margin:6px 0 16px; }
  .layout{ display:grid; grid-template-columns: 1fr 440px; gap:16px; align-items:start; }
  .panel{ background:var(--card); padding:14px; border:2px solid var(--purple); border-radius:10px; box-shadow:0 8px 20px rgba(75,0,130,0.08); }
  .panel h2{ margin:0 0 8px; color:var(--purple); font-size:18px; border-bottom:2px solid var(--yellow); padding-bottom:6px; }
  .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  label{ width:140px; font-weight:700; text-align:right; color:var(--purple); }
  input[type="text"], input[type="number"]{ padding:8px; border-radius:8px; border:2px solid var(--purple); background:var(--light); color:var(--purple); font-weight:600; }
  button.primary{ background:var(--purple); color:var(--yellow); padding:8px 12px; border-radius:8px; border:none; font-weight:800; cursor:pointer; }
  button.ghost{ background:transparent; border:1px solid var(--purple); color:var(--purple); padding:6px 10px; border-radius:6px; cursor:pointer; }
  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
  th,td{ border:1px solid rgba(75,0,130,0.08); padding:6px 8px; text-align:left; vertical-align:middle; }
  th{ background:var(--light); color:var(--purple); }
  .small{ font-size:12px; color:#444; }
  .notice{ font-size:13px; color:#333; margin-top:8px; text-align:center; }
  .vehicle{ border-radius:8px; padding:8px; border:1px dashed rgba(75,0,130,0.12); margin-bottom:8px; background:#fff; }
  .warn{ color:#9b1c1c; font-weight:800; margin-top:6px; }
  a.maplink{ color:var(--purple); font-weight:800; text-decoration:none; border-bottom:2px dotted var(--purple); }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Kirana Vehicle Planner</h1>
    <div class="layout">
      <!-- LEFT: input and DB -->
      <div class="panel">
        <h2>Orders (From Backend)</h2>
        <div class="row" style="justify-content:space-between">
          <div class="small">Depot (start) is fixed to <strong>Bengaluru center</strong>: <em>Lat 12.9716, Lng 77.5946</em>.</div>
          <div>
            <button id="btnAddRow" class="primary">Add Row</button>
            <button id="btnClearRows" class="ghost">Clear</button>
            <button id="btnPlan" class="primary">Plan Vehicles</button>
          </div>
        </div>

        <table id="ordersTable" aria-label="Orders table">
          <thead>
            <tr>
              <th>#</th><th>Order ID</th><th>Kirana Name</th><th>Kirana Lat</th><th>Kirana Lng</th>
              <th>Parcel L×B×H (cm)</th><th>Return?</th><th>Del</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="notice">Vehicle internal dims: <strong>220 × 149 × 149 cm</strong>.</div>
      </div>

      <!-- RIGHT: results -->
      <div class="panel">
        <h2>Plan & Routes</h2>
        <div id="resultSummary" class="small">No plan yet.</div>
        <div id="vehiclesArea" style="margin-top:10px;"></div>
        <div id="warnings"></div>
      </div>
    </div>
  </div>

<script>
const DEPOT_LAT = 12.9716;
const DEPOT_LNG = 77.5946;
const VEH_DIMS = [220,149,149];
const VEH_VOLUME = VEH_DIMS[0]*VEH_DIMS[1]*VEH_DIMS[2];
const MAX_KIRANA_PER_VEH = 3;
const BASE_SPEED_KMH = 30;
const DROP_MINUTES = 6;

function toRad(d){ return d * Math.PI/180; }
function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function permutations(arr){
  if(arr.length<=1) return [arr.slice()];
  const res=[];
  for(let i=0;i<arr.length;i++){
    const cur=arr[i];
    const rest=arr.slice(0,i).concat(arr.slice(i+1));
    const perms=permutations(rest);
    for(const p of perms) res.push([cur].concat(p));
  }
  return res;
}

const ordersTableBody = document.querySelector('#ordersTable tbody');

function addRow(initial={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td class="idx"></td>
    <td><input class="orderId" type="text" value="${initial.orderId||''}" /></td>
    <td><input class="kiranaName" type="text" value="${initial.kiranaName||''}" /></td>
    <td><input class="kiranaLat" type="number" step="any" value="${initial.kiranaLat||''}" /></td>
    <td><input class="kiranaLng" type="number" step="any" value="${initial.kiranaLng||''}" /></td>
    <td style="white-space:nowrap;">
      <input class="dimL" type="number" placeholder="L" style="width:56px" value="${initial.dimL||''}" /> ×
      <input class="dimB" type="number" placeholder="B" style="width:56px" value="${initial.dimB||''}" /> ×
      <input class="dimH" type="number" placeholder="H" style="width:56px" value="${initial.dimH||''}" />
    </td>
    <td style="text-align:center;"><input class="isReturn" type="checkbox" ${initial.isReturn? 'checked':''} /></td>
    <td style="text-align:center"><button class="delBtn">Del</button></td>
  `;
  ordersTableBody.appendChild(tr);
  tr.querySelector('.delBtn').addEventListener('click', ()=>{ tr.remove(); refreshIdx(); });
  refreshIdx();
}

function refreshIdx(){ Array.from(ordersTableBody.querySelectorAll('tr')).forEach((tr,i)=> tr.querySelector('.idx').textContent = i+1); }

document.getElementById('btnAddRow').addEventListener('click', ()=> addRow());
document.getElementById('btnClearRows').addEventListener('click', ()=> { if(confirm('Clear all rows?')){ ordersTableBody.innerHTML=''; refreshIdx(); } });

const prefilled = [
  {orderId:'K1001', kiranaName:'Kirana A', kiranaLat:12.9718, kiranaLng:77.5940, dimL:40, dimB:30, dimH:20, isReturn:false},
  {orderId:'K1002', kiranaName:'Kirana A', kiranaLat:12.9718, kiranaLng:77.5940, dimL:35, dimB:30, dimH:15, isReturn:true},
  {orderId:'K1003', kiranaName:'Kirana B', kiranaLat:12.9725, kiranaLng:77.5950, dimL:50, dimB:40, dimH:30, isReturn:false},
  {orderId:'K1004', kiranaName:'Kirana C', kiranaLat:12.9709, kiranaLng:77.5932, dimL:60, dimB:50, dimH:40, isReturn:false},
  {orderId:'K1005', kiranaName:'Kirana B', kiranaLat:12.9725, kiranaLng:77.5950, dimL:30, dimB:25, dimH:20, isReturn:true},
  {orderId:'K1006', kiranaName:'Kirana D', kiranaLat:12.9688, kiranaLng:77.5945, dimL:100, dimB:80, dimH:30, isReturn:false},
  {orderId:'K1007', kiranaName:'Kirana E', kiranaLat:12.9740, kiranaLng:77.5980, dimL:45, dimB:35, dimH:25, isReturn:false},
  {orderId:'K1008', kiranaName:'Kirana F', kiranaLat:12.9690, kiranaLng:77.5960, dimL:60, dimB:40, dimH:30, isReturn:false},
  {orderId:'K1009', kiranaName:'Kirana E', kiranaLat:12.9740, kiranaLng:77.5980, dimL:55, dimB:35, dimH:30, isReturn:true},
  {orderId:'K1010', kiranaName:'Kirana G', kiranaLat:12.9755, kiranaLng:77.5925, dimL:70, dimB:45, dimH:35, isReturn:false},
  {orderId:'K1011', kiranaName:'Kirana H', kiranaLat:12.9695, kiranaLng:77.5915, dimL:80, dimB:55, dimH:40, isReturn:false},
  {orderId:'K1012', kiranaName:'Kirana I', kiranaLat:12.9720, kiranaLng:77.5970, dimL:65, dimB:50, dimH:35, isReturn:true}
];
for(const r of prefilled) addRow(r);

function readOrders(){
  const rows = Array.from(ordersTableBody.querySelectorAll('tr'));
  const orders = [];
  for(const tr of rows){
    const orderId = tr.querySelector('.orderId').value.trim();
    const kiranaName = tr.querySelector('.kiranaName').value.trim();
    const kiranaLat = parseFloat(tr.querySelector('.kiranaLat').value);
    const kiranaLng = parseFloat(tr.querySelector('.kiranaLng').value);
    const dimL = parseFloat(tr.querySelector('.dimL').value)||0;
    const dimB = parseFloat(tr.querySelector('.dimB').value)||0;
    const dimH = parseFloat(tr.querySelector('.dimH').value)||0;
    const isReturn = tr.querySelector('.isReturn').checked;

    if(!kiranaName || isNaN(kiranaLat) || isNaN(kiranaLng)) continue;

    const dims = [dimL, dimB, dimH];
    const volume = dims[0]*dims[1]*dims[2];
    const fits = permutations(dims).some(p => p[0] <= VEH_DIMS[0] && p[1] <= VEH_DIMS[1] && p[2] <= VEH_DIMS[2]);

    orders.push({ orderId, stopName: kiranaName, stopLat: kiranaLat, stopLng: kiranaLng, dimL, dimB, dimH, volume, fits, isReturn });
  }
  return orders;
}

function groupKiranaOrders(orders){
  const groups = {};
  for(const o of orders){
    const key = o.stopName;
    if(!groups[key]) groups[key] = { stopName:o.stopName, stopLat:o.stopLat, stopLng:o.stopLng, orders:[], totalVolume:0, anyNotFit:false, hasReturn:false };
    groups[key].orders.push(o);
    groups[key].totalVolume += o.volume;
    if(!o.fits) groups[key].anyNotFit = true;
    if(o.isReturn) groups[key].hasReturn = true;
  }
  return Object.values(groups);
}

function planVehicles(){
  const orders = readOrders();
  if(orders.length===0){ alert('No valid orders in table.'); return; }

  const warnings = [];
  const cannotFit = orders.filter(o => !o.fits);
  if(cannotFit.length) warnings.push(`${cannotFit.length} parcel(s) cannot fit physically in vehicle.`);

  const kiranaGroups = groupKiranaOrders(orders);
  kiranaGroups.sort((a,b)=>b.totalVolume - a.totalVolume);

  let vehicles = [];
  let vid = 1;
  function newVehicle(){ return { id: vid++, assignedOrders: [], assignedKiranaStops: new Set(), usedVolume:0 }; }

  for(const g of kiranaGroups){
    let placed=false;
    for(const v of vehicles){
      if(v.assignedKiranaStops.size < MAX_KIRANA_PER_VEH && v.usedVolume + g.totalVolume <= VEH_VOLUME){
        v.assignedOrders.push(...g.orders);
        v.assignedKiranaStops.add(g.stopName);
        v.usedVolume += g.totalVolume;
        placed=true; break;
      }
    }
    if(!placed){
      const nv=newVehicle();
      nv.assignedOrders.push(...g.orders);
      nv.assignedKiranaStops.add(g.stopName);
      nv.usedVolume += g.totalVolume;
      vehicles.push(nv);
    }
  }

  const vehiclesResult = vehicles.map(v=>{
    const stopsMap = {};
    for(const o of v.assignedOrders){
      const key = o.stopName;
      if(!stopsMap[key]) stopsMap[key] = { stopName:o.stopName, lat:o.stopLat, lng:o.stopLng, orders:[] };
      stopsMap[key].orders.push(o);
    }
    const stops = Object.values(stopsMap);
    const unvis = stops.slice();
    const route = [];
    let cur = { lat: DEPOT_LAT, lng: DEPOT_LNG };
    while(unvis.length){
      unvis.sort((a,b)=>haversine(cur.lat,cur.lng,a.lat,a.lng)-haversine(cur.lat,cur.lng,b.lat,b.lng));
      const next=unvis.shift();
      next.orders.sort((x,y)=>(x.isReturn===y.isReturn)?0:(x.isReturn?1:-1));
      route.push(next);
      cur={lat:next.lat,lng:next.lng};
    }

    let totalDist=0; cur={lat:DEPOT_LAT,lng:DEPOT_LNG};
    for(const s of route){ totalDist+=haversine(cur.lat,cur.lng,s.lat,s.lng); cur={lat:s.lat,lng:s.lng}; }
    const durationMin=Math.round((totalDist/1000 / BASE_SPEED_KMH)*60 + route.length*DROP_MINUTES);
    return { id:v.id, stops:route, distance:Math.round(totalDist), durationMin, utilization:Math.round(v.usedVolume/VEH_VOLUME*100) };
  });

  renderPlan(vehiclesResult, warnings);
}

function renderPlan(vehiclesResult, warnings){
  const area=document.getElementById('vehiclesArea');
  const warnEl=document.getElementById('warnings');
  const summary=document.getElementById('resultSummary');
  area.innerHTML=''; warnEl.innerHTML='';

  summary.innerHTML=`<strong>${vehiclesResult.length}</strong> Truck(s) planned. Depot: Bengaluru center (${DEPOT_LAT}, ${DEPOT_LNG})`;
  if(warnings.length){ warnEl.innerHTML=warnings.map(w=>`<div class="warn">${w}</div>`).join(''); }

  vehiclesResult.forEach(v=>{
    const div=document.createElement('div'); div.className='vehicle';
    const stopsHtml=v.stops.map((s,idx)=>{
      const ordersList=s.orders.map(o=>`${o.orderId}${o.isReturn?' (Return)':''}`).join(', ');
      return `<div><strong>${idx+1}. ${s.stopName}</strong> — Orders: ${ordersList}<br/><span class="small">(${s.lat.toFixed(6)}, ${s.lng.toFixed(6)})</span></div>`;
    }).join('');
    const coords=v.stops.map(s=>`${s.lat},${s.lng}`);
    const gmapsUrl=`https://www.google.com/maps/dir/${DEPOT_LAT},${DEPOT_LNG}/${coords.join('/')}`;
    div.innerHTML=`
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Truck ${v.id}</strong> — Utilization: ${v.utilization}% — Stops: ${v.stops.length}</div>
        <div><a class="maplink" href="${gmapsUrl}" target="_blank">Open route in Google Maps</a></div>
      </div>
      <div class="small" style="margin-top:6px;">Distance: ${(v.distance/1000).toFixed(2)} km | Est. duration: ${v.durationMin} min</div>
      <div style="margin-top:6px;">${stopsHtml}</div>
    `;
    area.appendChild(div);
  });
}

document.getElementById('btnPlan').addEventListener('click', planVehicles);
</script>
</body>
</html>



